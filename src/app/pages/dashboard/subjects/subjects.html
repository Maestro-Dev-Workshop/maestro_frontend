<app-header class="z-10"></app-header>
@if (loadingSubjects) {
<div
  class="flex flex-col w-full h-full items-center justify-center absolute z-0 px-4 md:px-8"
>
  <div class="flex flex-row items-center text-4xl">
    <img src="images/spinner.gif" alt="" class="w-16 h-16 mx-2" />
    Loading Subjects...
  </div>
</div>
} @else { 
  @if (subjects.length == 0) {
    <div
      class="flex flex-col w-full h-full items-center justify-center absolute z-0"
    >
      <h1 class="m-2 text-xl md:text-3xl font-medium">
        Start Your Learning Journey
      </h1>
      <p class="w-full md:w-6/12 text-center px-4">
        Create subjects to keep your study materials neatly categorized and easy to
        find.
      </p>
      <button
        class="rounded-md m-4 md:m-8 px-5 py-3 text-white bg-prussian-blue-700 lg:hover:bg-prussian-blue-400 disabled:bg-prussian-blue-400 flex flex-row justify-center"
        (click)="createNewSubject()"
        [disabled]="loadingAction"
      >
        Create New Subject
        <img src="images/create-subject-icon.svg" alt="" class="w-4 ml-2" />
      </button>
    </div>
    } @else {
    <div class="flex flex-col w-full px-4 md:px-12 lg:px-32">
      <!-- Heading -->
      <div class="flex flex-row w-full justify-between my-4 space-y-4 md:space-y-0">
        <div class="flex flex-row items-center">
          <app-theme-icon name="subject-icon" className="w-8 h-4" />
          <span class="font-medium text-[var(--text-primary)]">My Subjects</span>
        </div>
        <button
          class="w-max rounded-md px-5 py-3 text-white bg-prussian-blue-700 lg:hover:bg-prussian-blue-400 disabled:bg-prussian-blue-400 flex flex-row justify-center text-xs"
          (click)="createNewSubject()"
          [disabled]="loadingAction"
        >
          Create New Subject
          <img src="images/create-subject-icon.svg" alt="" class="w-4 ml-2" />
        </button>
      </div>

      <!-- Subjects List -->
      <div class="w-full h-full flex flex-wrap items-start justify-center px-4 py-6">
        @for (subject of subjects; track $index) {

          <!-- Subject Card -->
          <div
            [class]="`relative flex flex-col rounded-2xl w-full lg:w-72 h-40 p-2 my-4 mx-0 lg:mx-4 shadow-sm lg:hover:shadow-lg lg:hover:top-2 
            transition-shadow duration-150 cursor-pointer bg-[var(--bg-page)] border-2 border-b-8`"
            [style.border-color]="
              subject.status.toLowerCase() === 'in progress'
                ? 'var(--text-primary-hover)'
                : subject.status.toLowerCase() === 'completed'
                  ? '#45AD40'
                  : '#EAAA08'
            "
            (click)="navigateSubject(subject)"
            (contextmenu)="onSubjectRightClick($event, subject)"
            role="button"
            tabindex="0"
            aria-label="Open subject {{ subject.name || 'Untitled' }}"
          >
            <!-- Icon buttons -->
            <div class="ml-auto flex my-1 items-start gap-1 shrink-0">
              <button
                class="p-1 rounded-md lg:hover:bg-[var(--bg-hover)] transition-colors"
                (click)="onSubjectRightClick($event, subject)"
                title="More options"
                aria-label="More options"
              >
                <app-theme-icon name="triple-dot-icon"></app-theme-icon>
              </button>
            </div>

            <!-- Top Section: Title + Progress Circle -->
            <div class="flex items-start justify-between gap-2">
              <!-- Title -->
              <h3 class="font-semibold text-base truncate flex-1" [title]="subject.name">
                <span class="font-medium text-2xl">
                  @if (subject.name) {
                    {{subject.name}}
                  } @else {
                    <em class="font-bold">Untitled</em>
                  }
                </span>
              </h3>

              <!-- Small Progress Circle with Percentage -->
              <div class="flex items-center gap-2">
                <div class="relative w-10 h-10">
                  <svg class="w-full h-full" viewBox="0 0 32 32" aria-hidden="true">
                    <!-- Background circle -->
                    <circle
                      cx="16"
                      cy="16"
                      r="14"
                      stroke="var(--text-primary)"
                      stroke-width="3"
                      fill="none"
                      class="opacity-30"
                    ></circle>
                    <!-- Progress circle -->
                    <circle
                      cx="16"
                      cy="16"
                      r="14"
                      stroke="var(--text-primary)"
                      stroke-width="3"
                      stroke-linecap="round"
                      fill="none"
                      stroke-dasharray="87.96"
                      [attr.stroke-dashoffset]="87.96 - (87.96 * (subject.completion || 0) / 100)"
                      transform="rotate(-90 16 16)"
                    ></circle>
                  </svg>
                  <!-- Percentage inside circle -->
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-[10px] font-semibold">
                      {{ subject.completion || 0 | number : "1.0-0" }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Topics (if any) -->
            <div class="flex flex-row items-center">
              <!-- Tiny green dot -->
              <div class="w-1 h-1 rounded-full bg-green-600"></div>
              <div class="text-xs font-medium px-2">
                {{
                  !subject.topics || subject.topics.length == 0 ? "NA"
                  : subject.topics.length == 1 ? "1 topic"
                  : subject.topics.length + " topics"
                }}
              </div>
            </div>

            <!-- Bottom Section: Tag list + Continue button -->
            <div class="flex flex-row items-end justify-between mt-auto">
              <!-- Tags (if any) -->
              @if (subject.extensions && subject.extensions.length > 0) {
                <div [title]="getExtensionsString(subject)">
                  <div class="text-xs font-medium">
                    Tags
                    <app-theme-icon name="tag-icon" className="w-3 inline"/>
                  </div>
                  <div class="flex flex-wrap items-center gap-1.5 mt-2">
                    @for (extension of subject.extensions.slice(0, 2); track $index) {
                      <span class="inline-flex items-center text-[0.6rem] bg-gray-400 text-white capitalize px-2 py-0.5 rounded-full">
                        {{ extension.type }}
                      </span>
                    }
                    @if (subject.extensions.length > 2) {
                      <span class="inline-flex items-center text-[0.6rem] bg-gray-500 text-white px-2 py-0.5 rounded-full">
                        +{{ subject.extensions.length - 2 }}
                      </span>
                    }
                  </div>
                </div>
              }
      
              <!-- Continue Button -->
              <div class="flex items-center justify-between mt-auto pt-3">
      
                <!-- Continue Button -->
                <button
                  class="text-xs text-white bg-prussian-blue-700 lg:hover:bg-prussian-blue-400 disabled:bg-prussian-blue-400 px-4 py-1.5 rounded-full font-medium transition-colors"
                  (click)="continueSubject($event, subject)"
                  [disabled]="loadingAction"
                  title="Continue"
                >
                  {{
                    subject.status.toLowerCase() == "in progress" ? "Continue"
                    : subject.status.toLowerCase() == "completed" ? "Completed"
                    : "Resume Setup"
                  }}
                </button>
              </div>
            </div>

          </div>
        }
      </div>

      <!-- Right-click contextual popup (Delete / Rate) -->
      @if (rightClickSubject) {
        <div
          class="fixed z-40 bg-[var(--bg-page)] border rounded-md shadow-lg"
          [ngStyle]="{ left: popup.x + 'px', top: popup.y + 'px' }"
          (click)="$event.stopPropagation()"
        >
          <ul class="p-2">
            <li
              class="flex items-center gap-2 px-3 py-2 hover:bg-[var(--bg-hover)] cursor-pointer rounded"
              (click)="openDelete()"
            >
              <app-theme-icon name="delete-subject-icon" className="w-4"></app-theme-icon>
              <span>Delete</span>
            </li>
      
            <li
              class="flex items-center gap-2 px-3 py-2 hover:bg-[var(--bg-hover)] cursor-pointer rounded"
              (click)="openRateModal()"
            >
              <app-theme-icon name="rate-icon" className="w-4"></app-theme-icon>
              <span>Rate</span>
            </li>
          </ul>
        </div>
      }

      <!-- Rate Modal -->
      @if (showRateModal) {
        <div
          class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
          (click)="closeRateModal()"
        >
          <div
            class="w-full max-w-md bg-[var(--bg-page)] rounded-xl p-6 px-8 shadow-lg text-center"
            (click)="$event.stopPropagation()"
          >
            <h4 class="text-2xl mb-3">
              How was your learning experience?
            </h4>
            <p class="text-sm text-[var(--text-alt)] mb-4">
              Your feedback helps improve Maestro
            </p>
      
            <!-- Star Rating -->
            <div class="flex flex-col items-center gap-2 mb-8">
              <div class="flex flex-row items-center">
                @for (s of [1, 2, 3, 4, 5]; track $index) {
                  <button
                    class="p-1 mx-2 hover:scale-110 transition-transform"
                    (click)="setRating(s)"
                    [attr.aria-pressed]="rating >= s"
                  >
                    <svg
                      [ngClass]="{
                        'text-yellow-400': rating >= s,
                        'text-gray-300': rating < s
                      }"
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-6 w-6"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.966a1 1 0 00.95.69h4.173c.969 0 1.371 1.24.588 1.81l-3.376 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.921-.755 1.688-1.54 1.118L10 13.347l-3.376 2.455c-.785.57-1.84-.197-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.631 9.393c-.783-.57-.38-1.81.588-1.81h4.173a1 1 0 00.95-.69L9.049 2.927z"
                      />
                    </svg>
                  </button>
                }
              </div>
              <span class="text-sm text-[var(--text-alt)] ml-2">{{ ratingDescription }}</span>
            </div>
      
            <!-- Feedback -->
            <textarea
              class="w-full bg-[var(--bg-page)] border border-[var(--text-primary)] rounded-md p-2 text-xs mb-4 focus:outline-none focus:ring-2 focus:ring-[var(--text-primary)]"
              rows="4"
              placeholder="Anything you'd like to add? Your input is valuable to us"
              [(ngModel)]="ratingFeedback"
            ></textarea>
      
            <div class="flex justify-end gap-2">
              <button
                class="px-4 py-2 rounded-md bg-[var(--bg-card)] lg:hover:bg-[var(--bg-card-hover)] transition-colors"
                (click)="closeRateModal()"
              >
                Cancel
              </button>
              <button
                class="px-4 py-2 rounded-md bg-prussian-blue-700 text-white hover:bg-prussian-blue-800 transition-colors"
                (click)="submitRating()"
              >
                Submit
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Feedback Button -->
      @if (showFeedbackBanner) {
        <div class="fixed bottom-0 left-0 right-0 z-40 flex gap-4 items-center justify-between px-6 py-4 bg-[var(--bg-banner)] ]">
          <!-- Text -->
          <p class="text-sm text-[var(--text-secondary)]">
            Got a minute? We’d love to hear how Maestro is working for you so far.
          </p>
      
          <!-- Actions -->
          <div class="flex items-center gap-4">
            <!-- CTA -->
            <a
              href="https://forms.gle/y6B3ReSJXCstUAE89"
              target="_blank"
              class="px-4 py-2 rounded-full text-center bg-[var(--bg-button)] lg:hover:bg-[var(--bg-button-hover)] text-[var(--text-primary)] transition-colors"
            >
              Share Feedback
            </a>
      
            <!-- Close -->
            <button
              class="text-xl leading-none text-[var(--text-alt-hover)] hover:text-[var(--text-primary)] transition"
              (click)="closeFeedbackBanner()"
              aria-label="Close feedback banner"
            >
              ×
            </button>
          </div>
        </div>
      }
    </div>
  }
  @if (loadingAction) {
    <div class="fixed left-4 bottom-4 lg:left-8 lg:bottom-8">
      <img src="images/spinner.gif" class="w-8 lg:w-12">
    </div>
  }
}
