<app-header class="z-10"></app-header>
@if (loadingSubjects) {
<div
  class="flex flex-col w-full h-full items-center justify-center absolute z-0 px-4 md:px-8"
>
  <div class="flex flex-row items-center text-4xl">
    <img src="images/spinner.gif" alt="" class="w-16 h-16 mx-2" />
    Loading Subjects...
  </div>
</div>
} @else { @if (subjects.length == 0) {
<div
  class="flex flex-col w-full h-full items-center justify-center absolute z-0"
>
  <h1 class="m-2 text-xl md:text-3xl font-medium">
    Start Your Learning Journey
  </h1>
  <p class="w-full md:w-6/12 text-center px-4">
    Create subjects to keep your study materials neatly categorized and easy to
    find.
  </p>
  <button
    class="rounded-md m-4 md:m-8 px-5 py-3 text-white bg-prussian-blue-700 lg:hover:bg-prussian-blue-400 disabled:bg-prussian-blue-400 flex flex-row justify-center"
    (click)="createNewSubject()"
    [disabled]="loadingCreate"
  >
    Create New Subject
    <img src="images/create-subject-icon.svg" alt="" class="w-4 ml-2" />
  </button>
</div>
} @else {
<div class="flex flex-col w-full px-4 md:px-12 lg:px-32">
  <!-- Heading -->
  <div class="flex flex-row w-full justify-between my-4 space-y-4 md:space-y-0">
    <div class="flex flex-row items-center">
      <app-theme-icon name="subject-icon" className="w-8 h-4" />
      <span class="font-medium text-[var(--text-primary)]">My Subjects</span>
    </div>
    <button
      class="w-max rounded-md px-5 py-3 text-white bg-prussian-blue-700 lg:hover:bg-prussian-blue-400 disabled:bg-prussian-blue-400 flex flex-row justify-center text-xs"
      (click)="createNewSubject()"
      [disabled]="loadingCreate"
    >
      Create New Subject
      <img src="images/create-subject-icon.svg" alt="" class="w-4 ml-2" />
    </button>
  </div>

<!-- Subjects List -->
<div class="w-full h-full flex flex-wrap items-start justify-center px-4 py-6">
  <ng-container *ngFor="let subject of subjects; trackBy: trackById">
    <!-- Subject Card -->
    <div
      class="relative flex flex-col rounded-2xl w-full sm:w-72 h-44 p-4 m-4 bg-[var(--bg-card)] shadow-sm hover:shadow-md transition-shadow duration-150 cursor-pointer"
      (click)="navigateSubject(subject)"
      (contextmenu)="onSubjectRightClick($event, subject)"
      role="button"
      tabindex="0"
      aria-label="Open subject {{ subject.name || 'Untitled' }}"
    >
      <!-- Top Section: Title + Icons -->
      <div class="flex items-start justify-between gap-2">
        <!-- Title -->
        <h3 class="text-prussian-blue-900 font-semibold text-base truncate flex-1">
          <ng-container *ngIf="subject.name; else untitled">{{
            subject.name
          }}</ng-container>
          <ng-template #untitled
            ><em class="font-bold">Untitled</em></ng-template
          >
        </h3>

        <!-- Icon buttons -->
        <div class="flex items-start gap-1 shrink-0">
          <button
            class="p-1 rounded-md hover:bg-gray-100 transition-colors"
            (click)="togglePin($event, subject)"
            title="Pin subject"
            aria-label="Pin subject"
          >
            <app-theme-icon name="pin-icon"></app-theme-icon>
          </button>

          <button
            class="p-1 rounded-md hover:bg-gray-100 transition-colors"
            (click)="openDeleteFromIcon($event, subject)"
            title="Delete subject"
            aria-label="Delete subject"
          >
            <app-theme-icon name="delete-icon"></app-theme-icon>
          </button>

          <button
            class="p-1 rounded-md hover:bg-gray-100 transition-colors"
            (click)="openMoreMenu($event, subject)"
            title="More options"
            aria-label="More options"
          >
            <app-theme-icon name="tag-icon"></app-theme-icon>
          </button>
        </div>
      </div>

      <!-- Status Badge -->
      <div class="mt-1.5">
        <span
          [ngClass]="getStatusColours(subject.status)"
          class="text-xs py-0.5 px-2 rounded-full font-medium inline-block"
        >
          {{
            subject.status.toLowerCase() !== "in progress" &&
            subject.status.toLowerCase() !== "completed"
              ? "Setup Incomplete"
              : subject.status
          }}
        </span>
      </div>

      <!-- Completion Text -->
      <div class="mt-2 text-xs text-gray-500">
        {{ subject.completion || 0 | number : "1.0-0" }}% complete
      </div>

      <!-- Tags (if any) -->
      @if (subject.tags && subject.tags.length > 0) {
      <div class="flex flex-wrap items-center gap-1.5 mt-2">
        <ng-container
          *ngFor="let tag of getDisplayTags(subject); let i = index"
        >
          <span
            class="inline-flex items-center text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full"
          >
            {{ tag }}
          </span>
        </ng-container>
      </div>
      }

      <!-- Bottom Section: Small Progress Indicator + Continue Button -->
      <div class="flex items-center justify-between mt-auto pt-3">
        <!-- Small Progress Circle with Percentage -->
        <div class="flex items-center gap-2">
          <div class="relative w-8 h-8">
            <svg class="w-full h-full" viewBox="0 0 32 32" aria-hidden="true">
              <!-- Background circle -->
              <circle
                cx="16"
                cy="16"
                r="14"
                stroke="#E5E7EB"
                stroke-width="3"
                fill="none"
              ></circle>
              <!-- Progress circle -->
              <circle
                cx="16"
                cy="16"
                r="14"
                stroke="#0B4A6F"
                stroke-width="3"
                stroke-linecap="round"
                fill="none"
                stroke-dasharray="87.96"
                [attr.stroke-dashoffset]="87.96 - (87.96 * (subject.completion || 0) / 100)"
                transform="rotate(-90 16 16)"
              ></circle>
            </svg>
            <!-- Percentage inside circle -->
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-[10px] font-semibold text-prussian-blue-900">
                {{ subject.completion || 0 | number : "1.0-0" }}%
              </span>
            </div>
          </div>
        </div>

        <!-- Continue Button -->
        <button
          class="text-xs text-white bg-prussian-blue-700 hover:bg-prussian-blue-800 px-4 py-1.5 rounded-full font-medium transition-colors"
          (click)="continueSubject($event, subject)"
          title="Continue"
        >
          Continue
        </button>
      </div>
    </div>
  </ng-container>
</div>

<!-- Right-click contextual popup (Delete / Rate) -->
<div
  *ngIf="rightClickSubject"
  class="absolute z-50 bg-white border rounded-md shadow-lg"
  [ngStyle]="{ left: popup.x + 'px', top: popup.y + 'px' }"
  (click)="$event.stopPropagation()"
>
  <ul class="p-2">
    <li
      class="flex items-center gap-2 px-3 py-2 hover:bg-gray-100 cursor-pointer rounded"
      (click)="openDelete()"
    >
      <app-theme-icon name="delete-subject-icon"></app-theme-icon>
      <span>Delete</span>
    </li>

    <li
      class="flex items-center gap-2 px-3 py-2 hover:bg-gray-100 cursor-pointer rounded"
      (click)="openRateModal()"
    >
      <app-theme-icon name="rate-icon"></app-theme-icon>
      <span>Rate</span>
    </li>
  </ul>
</div>

<!-- Rate Modal -->
<div
  *ngIf="showRateModal"
  class="fixed inset-0 z-60 flex items-center justify-center bg-black/40 p-4"
  (click)="closeRateModal()"
>
  <div
    class="w-full max-w-md bg-white rounded-xl p-6 shadow-lg"
    (click)="$event.stopPropagation()"
  >
    <h4 class="text-lg font-semibold text-prussian-blue-900 mb-3">
      How was your learning experience?
    </h4>
    <p class="text-sm text-gray-600 mb-4">
      Your feedback helps improve Maestro
    </p>

    <!-- Stars -->
    <div class="flex items-center gap-2 mb-2">
      <button
        *ngFor="let s of [1, 2, 3, 4, 5]"
        class="p-1 hover:scale-110 transition-transform"
        (click)="setRating(s)"
        [attr.aria-pressed]="rating >= s"
      >
        <svg
          [ngClass]="{
            'text-yellow-400': rating >= s,
            'text-gray-300': rating < s
          }"
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.966a1 1 0 00.95.69h4.173c.969 0 1.371 1.24.588 1.81l-3.376 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.921-.755 1.688-1.54 1.118L10 13.347l-3.376 2.455c-.785.57-1.84-.197-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.631 9.393c-.783-.57-.38-1.81.588-1.81h4.173a1 1 0 00.95-.69L9.049 2.927z"
          />
        </svg>
      </button>
      <span class="text-sm text-gray-700 ml-2">{{ ratingDescription }}</span>
    </div>

    <!-- Feedback -->
    <textarea
      class="w-full border border-gray-300 rounded-md p-2 text-sm mb-4 focus:outline-none focus:ring-2 focus:ring-prussian-blue-700"
      rows="4"
      placeholder="Anything you'd like to add? Your input is valuable to us"
      [(ngModel)]="ratingFeedback"
    ></textarea>

    <div class="flex justify-end gap-2">
      <button
        class="px-4 py-2 rounded-md bg-gray-100 hover:bg-gray-200 transition-colors"
        (click)="closeRateModal()"
      >
        Cancel
      </button>
      <button
        class="px-4 py-2 rounded-md bg-prussian-blue-700 text-white hover:bg-prussian-blue-800 transition-colors"
        (click)="submitRating()"
      >
        Submit
      </button>
    </div>
  </div>
</div>

  <!-- Feedback Button -->

  <div
    *ngIf="showFeedbackBanner"
    class="fixed bottom-0 left-0 right-0 z-40 flex items-center justify-between px-6 py-4 bg-[var(--bg-banner)] ]"
  >
    <!-- Text -->
    <p class="text-sm text-[var(--text-secondary)]">
      Got a minute? We’d love to hear how Maestro is working for you so far.
    </p>

    <!-- Actions -->
    <div class="flex items-center gap-4">
      <!-- CTA -->
      <a
        href="https://forms.gle/y6B3ReSJXCstUAE89"
        target="_blank"
        class="px-4 py-2 rounded-full bg-[var(--bg-button)] lg:hover:bg-[var(--bg-button-hover)] text-[var(--text-primary)] transition-colors"
      >
        Share Feedback
      </a>

      <!-- Close -->
      <button
        class="text-xl leading-none text-[var(--text-alt-hover)] hover:text-[var(--text-primary)] transition"
        (click)="closeFeedbackBanner()"
        aria-label="Close feedback banner"
      >
        ×
      </button>
    </div>
  </div>
</div>
} }

<!-- Popup Delete button
@if (rightClickSubject) {
<div
  [class]="`fixed p-1 bg-[var(--bg-page)] rounded-md flex flex-col items-center justify-center top-[${popup.y}px] left-[${popup.x}px]`"
  [style.top.px]="popup.y + 8"
  [style.left.px]="popup.x + 8"
>
  <button
    class="rounded-md px-2 py-1 text-white bg-red-600 lg:hover:bg-red-400"
    (click)="openDelete()"
  >
    Delete
  </button>
</div>
} -->
