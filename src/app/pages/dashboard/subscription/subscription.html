<app-header class="z-10"></app-header>

@if (pageLoading) {
  <div class="fixed inset-0 bg-[var(--bg-page)] bg-opacity-90 z-50 flex items-center justify-center">
    <div class="flex flex-col items-center">
      <img src="images/spinner.gif" alt="" class="w-24 mb-4">
      <span class="text-4xl">{{loadText}}</span>
    </div>
  </div>
}

<div class="flex flex-row w-full min-h-[calc(100vh-80px)] bg-gray-50 border-t border-gray-300">

  <!-- ======================= -->
  <!-- SIDEBAR -->
  <!-- ======================= -->
  <aside class="w-64 bg-[var(--bg-page)] border-r border-gray-300 p-6 hidden md:block">

    <div class="flex flex-row items-center">
      <button class="rounded-full p-3 bg-prussian-blue-700 lg:hover:bg-prussian-blue-400" routerLink="/dashboard">
        <app-theme-icon name="subject-icon" className="w-8" />
      </button>
      <span class="text-[var(--text-primary)] lg:hover:text-[var(--text-primary-hover)] mx-4 cursor-pointer font-medium"
            routerLink="/dashboard">
        Back to Subjects
      </span>
    </div>

    <nav class="flex flex-col space-y-3 mt-4">

      <!-- ACCOUNT REMOVED â€” COMMENTED OUT -->
      <!--
      <button
        class="text-left px-3 py-2 lg:hover:bg-gray-100"
        [ngClass]="{'border-l-4 border-prussian-blue-900': activeTab() === 'account'}"
        (click)="openTab('account')"
      >
        Account
      </button>
      -->

      <button
        class="text-left px-3 py-2 lg:hover:bg-[var(--bg-hover)]"
        [ngClass]="{'border-l-4 border-[var(--text-primary)]': activeTab() === 'billing'}"
        (click)="openTab('billing')"
      >
        Billing & Usage
      </button>
    </nav>

  </aside>



  <!-- ======================= -->
  <!-- MAIN CONTENT -->
  <!-- ======================= -->
  <main class="flex-1 p-6 sm:p-10 overflow-y-auto bg-[var(--bg-page)]">


    <!-- ============================================================ -->
    <!-- BILLING TAB CONTENT (ACCOUNT TAB HIDDEN) -->
    <!-- ============================================================ -->
    @if (activeTab() === 'billing') {

      <!-- ======================= -->
      <!-- USAGE SECTION -->
      <!-- ======================= -->
      <h2 class="text-xl font-semibold mb-6">Usage</h2>
      <div class="p-[1px] bg-prussian-blue-700 mb-10"></div>

      <div class="bg-[var(--bg-page) border border-gray-300 p-6 sm:p-10 rounded-xl shadow-sm  
                  flex flex-col md:flex-row items-center md:items-start gap-10 mb-14">

        <!-- ===== DONUT CHART (Responsive + Animated) ===== -->
        <div class="relative w-40 h-40 sm:w-56 sm:h-56">
          <svg viewBox="0 0 200 200" class="w-full h-full transform -rotate-90">

            <!-- OUTER BG -->
            <circle cx="100" cy="100" r="80"
                    stroke="#E5E7EB" stroke-width="12" fill="none" />

            <!-- OUTER PROGRESS -->
            <circle
              cx="100" cy="100" r="80"
              stroke="#0D1B2A" stroke-width="12" fill="none" stroke-linecap="round"
              [attr.stroke-dasharray]="outerDashArray"
              [attr.stroke-dashoffset]="outerDashOffset"
              class="transition-all duration-[1200ms] ease-out"
            />

            <!-- INNER BG -->
            <circle cx="100" cy="100" r="55"
                    stroke="#E5E7EB" stroke-width="12" fill="none" />

            <!-- INNER PROGRESS -->
            <circle
              cx="100" cy="100" r="55"
              stroke="#D4A401" stroke-width="12" fill="none" stroke-linecap="round"
              [attr.stroke-dasharray]="innerDashArray"
              [attr.stroke-dashoffset]="innerDashOffset"
              class="transition-all duration-[1200ms] ease-out"
            />

          </svg>
        </div>

        <!-- ===== USAGE TEXT ===== -->
        <div class="flex flex-col space-y-6 sm:space-y-8">

          <div>
            <p class="font-semibold text-[var(--text-primary)] flex items-center">
              <span class="w-3 h-3 bg-[#0D1B2A] rounded-full mr-2"></span>
              Lesson Generation
            </p>
            <p class="text-sm text-[var(--text-primary-hover)]">
              {{ generatedLessons }}/{{ generatedLimit }} personalized lessons generated
            </p>
          </div>

          <div>
            <p class="font-semibold text-[var(--text-primary)] flex items-center">
              <span class="w-3 h-3 bg-yellow-600 rounded-full mr-2"></span>
              Saved Lessons
            </p>
            <p class="text-sm text-[var(--text-primary-hover)]">
              {{ savedLessons }}/{{ savedLimit }} personalized lessons saved
            </p>
          </div>
        </div>

      </div>




      <!-- ======================= -->
      <!-- PLAN SECTION -->
      <!-- ======================= -->
      <h2 class="text-xl font-semibold mb-8">Your Plan</h2>
      <div class="p-[1px] bg-prussian-blue-700 mb-10"></div>


      <!-- ======================= -->
      <!-- PLANS -->
      <!-- ======================= -->
      <div class="overflow-x-auto scrollbar-hide mb-10">
        <div class="flex space-x-8 min-w-max">

          @for (plan of plans(); track $index) {
            <!-- PLAN CARD TEMPLATE -->
            <div [class]="`rounded-xl w-80 border border-gray-300 shadow-sm p-8 min-h-[450px] flex flex-col 
              ${status()?.plan_code == plan.code ? 'bg-[#e8eef2] text-black' : 'bg-black text-white'}`">
              <img [src]="`images/${status()?.plan_code == plan.code ? 'starblack' : 'starwhite'}.svg`" class="w-4 mb-2">  
              <h3 class="text-lg font-semibold">{{plan.name}}</h3>
              <!-- ${status()?.plan_code == plan.code ? '' : ''} -->
              <p class="text-3xl font-bold mt-1">{{ countryCode() | currencyLocalizer}}{{plan.display_price | number:'1.0-0'}} <span [class]="`text-sm font-light ${status()?.plan_code == plan.code ? '' : 'text-gray-300'}`">/month</span></p>
              <p [class]="`text-sm ${status()?.plan_code == plan.code ? '' : 'text-gray-300'} mt-1`">{{plan.description}}</p>
    
              <hr class="mt-4 border-t border-gray-600" />
    
              <ul [class]="`mt-6 space-y-3 text-sm ${status()?.plan_code == plan.code ? '' : 'text-gray-100'} flex-1`">
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">{{plan.monthly_subject_creations}} lessons / month</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">Store {{plan.subject_capacity}} lessons</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">Upload {{plan.single_file_size}}MB files</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">Total file sizes {{plan.subject_total_files_size}}MB</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">{{plan.subject_file_count}} files per subject</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">{{plan.exercise_question_count}} exercise questions</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">{{plan.exam_question_count}} exam questions</li>
                <li class="flex"><img [src]="`images/${status()?.plan_code == plan.code ? 'check' : 'whitecheck'}.svg`" class="w-4 mr-2">
                  @if ((plan.chatbot_token_count ?? 0) <= 500000) {
                    Limited Chatbot Interactions
                  } @else if ((plan.chatbot_token_count ?? 0) <= 1000000) {
                    Moderate Chatbot Interactions
                  } @else {
                    Extensive Chatbot Interactions
                  }
                </li>
              </ul>
    
              @if (status()?.plan_code !== plan.code) {
                <button class="mt-6 w-full py-2 bg-white text-black rounded-md lg:hover:bg-gray-300" (click)="switchPlan(plan.code)">Switch to {{plan.name}}</button>
              } @else {
                <button class="mt-6 w-full py-2 border border-prussian-blue-900 bg-[#e8eef2] text-black rounded-md cursor-default">Current Plan</button>
              }
            </div>
          }
        </div>

      </div>

    }
    @if (countryCode() !== "NG") {
      <div class="text-sm">*Prices shown in {{ countryCode() }} currency. Charged in NGN. Your bank converts at their rate.</div>
    }
  </main>

</div>
